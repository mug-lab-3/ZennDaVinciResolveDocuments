---
title: 【DaVinci Resolve】 回転した四角形のX・Yを求める【Fusion】"
emoji: "📐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["davinciresolve"]
published: false
---

# 🐥 はじめに

みなさん、こんにちは。[Mug](https://www.youtube.com/@MugLabVideoEditing)です ✨

これは 📽[DaVinci Resolve](https://www.blackmagicdesign.com/jp/products/davinciresolve)についての記事です。
DaVinci Resolve の Fusion では、コントロールの値として`Expression`を設定することが出来ますが
そこに入力する計算式で、四角形の計算方法についての記事です。

![Context Menu](/images/articles/expression/context-menu.png)
_Expression 設定メニュー(右クリック)_

![Expression Sample](/images/articles/expression/expression-sample.png)
_ここに入力する計算式の話_

![Width/Height](/images/articles/rotation-size/result.png)
👆 やりたいのはこちら、青い四角形の幅・高さの計算方法

Expression の基本的は計算は 👇 こっちを見てね 🐼
https://zenn.dev/muglab3/articles/1d32711f7eb419

:::message
📽DaVinci Resolve 19.1.3 で確認しています。
:::

# 回転している四角形の幅・高さを計算する

四角形を回転させたときの X 軸方向の長さ、Y 軸方向の高さは
🏫 学校で習うように 📐 三角関数で計算できますが
DaVinci Resolve ではいくつか注意点があります ❗

## 三角関数に渡す角度は radian

Expression では `sin`, `cos`, `tan` という関数が使えますが、この関数が受け取る角度は radian です
しかし、インスペクタのコントロールに入力する値は基本的に degree です
なのでまずは degree から radian に変換する必要があります 🤔
その時使用する関数が`rad`です

### 60° を radian に変換する

```lua
rad(60)
```

👉 1.047

### サイン、コサイン、タンジェント 💃

```lua
sin(rad(60))
```

👉 0.866

```lua
cos(rad(60))
```

👉 0.500

```lua
tan(rad(60))
```

👉 1.732

## アスペクト比を考慮する

DaVinci Resolve では基本的に座標は全体を 1.0 とした相対座標となっています
これは縦・横どちらも同じです
そのためアスペクト比が 1:1 ではない場合、同じ値でも絶対的な大きさは縦と横で異なります
これが`Expression`でサイズ計算を行う上で重要なポイントとなります 😤

👇 縦と横ともに 0.5 を設定しても正方形にはならない 😮
![Width/Height](/images/articles/rotation-size/aspect-ratio.png)

### アスペクト比計算

まずはアスペクト比を知るところから
これには`comp:GetPrefs`を用いて`Comp.FrameFormat.Width`と`Comp.FrameFormat.Height`から縦横サイズを取得して計算します

:::message
これはもうちょっといい方法があるかもです 😭
:::

#### 1920x1080 で作っている場合

```lua
comp:GetPrefs("Comp.FrameFormat.Width")
```

👉 1920

```lua
comp:GetPrefs("Comp.FrameFormat.Height")
```

👉 1080

```lua
comp:GetPrefs("Comp.FrameFormat.Width") / comp:GetPrefs("Comp.FrameFormat.Height")
```

👉 1.777

これを高さ側にかけ合わせると

```lua
0.5 * (comp:GetPrefs("Comp.FrameFormat.Width") / comp:GetPrefs("Comp.FrameFormat.Height"))
```

![Width/Height](/images/articles/rotation-size/square.png)
正方形になります 👍

### アスペクト比計算結果を覚えておく

アスペクト比はサイズの計算では頻繁に出てきます
それを 👆 のような長い式を入れていると大変 😵‍💫 なので、計算結果を覚えておいて簡単に使えるようにします

それには`self:SetData`, `self:GetData`を使用します

#### SetData

self:SetData("`合言葉`", `覚えておく値`) です

```lua
self:SetData("aspectRatio", (comp:GetPrefs("Comp.FrameFormat.Width") / comp:GetPrefs("Comp.FrameFormat.Height")))
```

#### GetData

self:SetData("`合言葉`") です

```lua
self:GetData("aspectRatio")
```

👉 1.777

#### Start Render Script

ではどこで`self:SetData`すればいいの？というと
`計算式をいれる予定のノード`の`Start Render Script`です

`Start Render Script`では rendering 開始時に実行したい処理を書くところなので
ここでアスペクト比を覚えておくようにします 😤

![Width/Height](/images/articles/rotation-size/start-render-script.png)

## 👾 実践 👾

ここまでの内容を使って
四角形をピッタリ収めるような回転した四角形の幅と高さを計算します

![Width/Height](/images/articles/rotation-size/result.png)
👆 やりたいのはこちら

# 🐔 おわりに

ちょっとむずかしいね！
