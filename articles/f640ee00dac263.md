---
title: 【DaVinci Resolve】 回転した四角形の計算【Fusion】
emoji: "📐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["davinciresolve"]
published: true
---

# 🐥 はじめに

みなさん、こんにちは。[Mug](https://www.youtube.com/@MugLabVideoEditing)です ✨

これは 📽[DaVinci Resolve](https://www.blackmagicdesign.com/jp/products/davinciresolve)についての記事です。
DaVinci Resolve の Fusion では Expression として計算式を設定できますが
それを使って回転した四角形の幅・高さを求める計算方法についての記事です。

![Width/Height](/images/articles/rotation-size/result.png)
👆 やりたいのはこちら、黄色い四角形が収まるように青い四角形の幅・高さの計算する

Expression の基本的は計算は 👇 こっちを見てね 🐼
https://zenn.dev/muglab3/articles/1d32711f7eb419

:::message
📽DaVinci Resolve 19.1.3 で確認しています。
:::

# 🐦 回転した四角形の幅・高さを計算する

四角形を回転させたときの X 軸方向の長さ、Y 軸方向の高さは
🏫 学校で習うように 📐 三角関数で計算できますが、
DaVinci Resolve ではいくつか注意点があります ❗

## 三角関数に渡す角度は radian

Expression では 三角関数として`sin`, `cos`, `tan` という関数が使えます
しかしこれらの関数が受け取る角度は `radian` です 😮
インスペクタのコントロールに入力する値は基本的に `degree` なので
`degree` から `radian` に変換してから`sin`, `cos`, `tan` に渡す必要があります
その時に使用するのが`rad`という関数です 👍

### 60° を radian に変換する

```lua
rad(60)
```

👉 1.047

### サイン、コサイン、タンジェント 💃

```lua
sin(rad(60))
```

👉 0.866

```lua
cos(rad(60))
```

👉 0.500

```lua
tan(rad(60))
```

👉 1.732

## アスペクト比を考慮する

DaVinci Resolve では基本的に座標は全体を 1.0 とした相対座標となっています
これは縦・横どちらも同じです
そのためアスペクト比が 1:1 ではない場合、同じ値でも絶対的な大きさが縦と横で異なります
これが`Expression`でサイズ計算を行う上で重要なポイントとなります 😤

👇 縦と横ともに 0.5 を設定しても正方形にはならない 😮
![Width/Height](/images/articles/rotation-size/aspect-ratio.png)

### アスペクト比計算

アスペクト比をは`comp:GetPrefs`を用いて
`Comp.FrameFormat.Width`と`Comp.FrameFormat.Height`から縦横サイズを取得して計算します

:::message
これはもうちょっといい方法があるかもです 😭
:::

:::message
以下の"👉"で示されている値は 1920x1080 で作っている場合の値です
:::

```lua
comp:GetPrefs("Comp.FrameFormat.Width")
```

👉 1920

```lua
comp:GetPrefs("Comp.FrameFormat.Height")
```

👉 1080

```lua
comp:GetPrefs("Comp.FrameFormat.Width") / comp:GetPrefs("Comp.FrameFormat.Height")
```

👉 1.777

これを高さ側にかけ合わせると

```lua
0.5 * (comp:GetPrefs("Comp.FrameFormat.Width") / comp:GetPrefs("Comp.FrameFormat.Height"))
```

![Width/Height](/images/articles/rotation-size/square.png)
正方形になります 👍

### アスペクト比計算結果を覚えておく

アスペクト比はサイズの計算では頻繁に出てきます
それに 👆 のような長い式を毎回入れていると大変 😵‍💫 なので、
計算結果を覚えておいて簡単に使えるようにします

それには`self:SetData`, `self:GetData`を使用します

#### SetData

self:SetData("`合言葉`", `覚えておく値`) です

```lua
self:SetData("aspectRatio", (comp:GetPrefs("Comp.FrameFormat.Width") / comp:GetPrefs("Comp.FrameFormat.Height")))
```

#### GetData

self:SetData("`合言葉`") です

```lua
self:GetData("aspectRatio")
```

👉 1.777

#### Start Render Script

ではどこで`self:SetData`すればいいの？🤔 というと
`計算式をいれる予定のノード`の`Start Render Script`です

`Start Render Script`では rendering 開始時に実行したい処理を書くところなので
ここでアスペクト比を覚えておくようにします 😤

![Width/Height](/images/articles/rotation-size/start-render-script.png)

## 👾 実践 👾

ここまでの内容を使って
四角形をピッタリ収めるような回転した四角形の`幅`と`高さ`を計算してみます‼️

![Width/Height](/images/articles/rotation-size/result.png)
👆 こちらが期待値です

黄色の四角形: Rectangle1
青色の四角形: Rectangle2

Rectangle2 の`幅`と`高さ`を調整します

### 幅

2 つの部分に分けて考えて、それらを足して`幅`とします
幅を求めたいので三角関数のマイナス値側はいらないです 👻
`abs`関数を使って絶対値に変換します

#### 紫の直角三角形から底辺部分(緑)

![width*cos](/images/articles/rotation-size/wcos.png)

```lua
Rectangle1.Width * abs(cos(rad(Angle)))
```

#### 紫の直角三角形から高さ部分(緑)

![width*cos](/images/articles/rotation-size/hsin.png)

```lua
Rectangle1.Height * abs(sin(rad(Angle))) * (1 / self:GetData("aspectRatio"))
```

こちらは`Rectangle1.Height`をもとに計算するので、`アスペクト比: self:GetData("aspectRatio")`の逆数をかけます

#### 結果

これらを足して、`幅`を求める式はこちらです 😤

```lua
(Rectangle1.Width * abs(cos(rad(Angle)))) + (Rectangle1.Height * abs(sin(rad(Angle))) * (1 / self:GetData("aspectRatio")))
```

### 高さ

`高さ`も幅と同様に、2 つの部分に分けて考えて、それらを足して`高さ`とします
`高さ`の場合は前述のようにアスペクト比を考慮して`アスペクト比: self:GetData("aspectRatio")`をかけます

#### 紫の直角三角形から高さ部分(緑)

![width*cos](/images/articles/rotation-size/wsin.png)

```lua
Rectangle1.Width * abs(sin(rad(Angle))) * self:GetData("aspectRatio")
```

#### 紫の直角三角形から底辺部分(緑)

![width*cos](/images/articles/rotation-size/hcos.png)

```lua
Rectangle1.Height * abs(cos(rad(Angle))) * (1 / self:GetData("aspectRatio")) * self:GetData("aspectRatio")
```

こちらは`Rectangle1.Height`をもとに計算するので、`アスペクト比: self:GetData("aspectRatio")`の逆数をかけます
:::message
こちらにもアスペクト比をかけるので結果的に打ち消されます
:::

#### 結果

これらを足して、`高さ`を求める式はこちらです 😤

```lua
((Rectangle1.Width * abs(sin(rad(Angle)))) + (Rectangle1.Height * abs(cos(rad(Angle))) * (1 / self:GetData("aspectRatio")))) * self:GetData("aspectRatio")
```

# 🐔 おわりに

ちょっとむずかしいね！🐼
